name: Build and Package BrawlInstaller

on:
  push:
    branches:
      - release

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        rid: [linux-arm, linux-arm64]  # 32-bit and 64-bit
        arch-name: [arm32, arm64]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq libgtk-3-0 libayatana-appindicator3-1

      - name: Get Version from JSON
        id: get-version
        shell: bash
        run: |
          PACKAGE_JSON=$(jq -c . < BrawlInstaller/Resources/update.json)
          if [ -z "$PACKAGE_JSON" ]; then
            echo "Error: Failed to read update.json!"
            exit 1
          fi
          VERSION=$(echo "$PACKAGE_JSON" | jq -r '.Version')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Echo Version
        run: echo "The version is ${{ steps.get-version.outputs.version }}"

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore NuGet Packages
        run: dotnet restore BrawlInstaller.sln

      - name: Publish for Raspberry Pi
        run: |
          PUBLISH_DIR="${{ github.workspace }}/publish-${{ matrix.arch-name }}"
          mkdir -p $PUBLISH_DIR
          dotnet publish BrawlInstaller/BrawlInstaller.csproj \
            -c Release \
            -r ${{ matrix.rid }} \
            --self-contained true \
            -o $PUBLISH_DIR \
            /p:PublishSingleFile=true \
            /p:IncludeNativeLibrariesForSelfExtract=true

      - name: List Publish Directory
        run: ls -lah ${{ github.workspace }}/publish-${{ matrix.arch-name }}

  release:
    needs: build
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Velopack
        run: |
          dotnet tool install -g vpk
          export PATH="$PATH:$HOME/.dotnet/tools"

      - name: Pack and Upload 32-bit
        if: ${{ matrix.arch-name == 'arm32' }}
        run: |
          vpk download github --repoUrl https://github.com/pompom454/BrawlInstaller-pi
          vpk pack --packId BrawlInstaller --packVersion ${{ steps.get-version.outputs.version }} --releaseNotes BrawlInstaller/Resources/changelog.md --packDir "${{ github.workspace }}/publish-arm32" --mainExe BrawlInstaller --packTitle "BrawlInstaller (ARM32)" --icon BrawlInstaller/BrawlInstallerIcon.ico
          vpk upload github --repoUrl https://github.com/pompom454/BrawlInstaller-pi --publish --releaseName "BrawlInstaller ${{ steps.get-version.outputs.version }} (ARM32)" --tag "v${{ steps.get-version.outputs.version }}-arm32" --token ${{ secrets.GITHUB_TOKEN }}

      - name: Pack and Upload 64-bit
        if: ${{ matrix.arch-name == 'arm64' }}
        run: |
          vpk download github --repoUrl https://github.com/pompom454/BrawlInstaller-pi
          vpk pack --packId BrawlInstaller --packVersion ${{ steps.get-version.outputs.version }} --releaseNotes BrawlInstaller/Resources/changelog.md --packDir "${{ github.workspace }}/publish-arm64" --mainExe BrawlInstaller --packTitle "BrawlInstaller (ARM64)" --icon BrawlInstaller/BrawlInstallerIcon.ico
          vpk upload github --repoUrl https://github.com/pompom454/BrawlInstaller-pi --publish --releaseName "BrawlInstaller ${{ steps.get-version.outputs.version }} (ARM64)" --tag "v${{ steps.get-version.outputs.version }}-arm64" --token ${{ secrets.GITHUB_TOKEN }}